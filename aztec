#!/bin/bash

set -e

echo "Виберіть дію:"
echo "1. Встановити ноду"
echo "2. Запустити ноду"
echo "3. Зупинити ноду"
read -p "Ваш вибір (1/2/3): " choice

if [[ "$choice" == "1" ]]; then
    echo "Починаємо встановлення ноди Aztec..."

    # Запит параметрів
    read -p "Введіть L1_RPC_URL (ВАШ SEPOLIA RPC): " L1_RPC_URL
    read -p "Введіть L1_CONSENSUS_URL (ВАШ SEPOLIA Beacon): " L1_CONSENSUS_URL
    read -p "Введіть VALIDATOR_PRIVATE_KEY (ВАШ ПРИВАТНИЙ КЛЮЧ): " VALIDATOR_PRIVATE_KEY
    read -p "Введіть COINBASE_ADDRESS (ВАШ АДРЕС 0x...): " COINBASE_ADDRESS

    echo ""
    echo "Крок 1/7: Встановлення Docker..."

    sudo apt update
    sudo apt install -y apt-transport-https ca-certificates curl gnupg lsb-release

    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker.gpg

    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
    $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

    sudo apt update
    sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

    sudo usermod -aG docker $USER

    echo "Docker встановлено."

    echo ""
    echo "Крок 2/7: Встановлення утиліт..."

    sudo apt install -y screen net-tools psmisc jq ufw nano

    echo ""
    echo "Крок 3/7: Встановлення AZTEC CLI..."

    curl -fsSL https://install.aztec.network | bash
    echo 'export PATH="$HOME/.aztec/bin:$PATH"' >> ~/.bashrc
    export PATH="$HOME/.aztec/bin:$PATH"

    echo ""
    echo "Крок 4/7: Оновлення AZTEC до alpha-testnet..."
    aztec-up alpha-testnet

    echo ""
    echo "Крок 5/7: Отримання публічного IP..."
    IP=$(curl -s https://api.ipify.org)
    echo "IP сервера: $IP"

    echo ""
    echo "Крок 6/7: Створення скриптів запуску/зупинки..."

    # start script
    cat > $HOME/start_aztec_node.sh << EOL
#!/bin/bash
export PATH=\$PATH:\$HOME/.aztec/bin
aztec start --node --archiver --sequencer --auto-update config-and-version \\
  --network alpha-testnet \\
  --port 8080 \\
  --l1-rpc-urls $L1_RPC_URL \\
  --l1-consensus-host-urls $L1_CONSENSUS_URL \\
  --sequencer.validatorPrivateKey $VALIDATOR_PRIVATE_KEY \\
  --sequencer.coinbase $COINBASE_ADDRESS \\
  --p2p.p2pIp $IP
EOL
    chmod +x $HOME/start_aztec_node.sh

    # run_forever script
    cat > $HOME/run_forever.sh << EOL
#!/bin/bash
while true; do
  \$HOME/start_aztec_node.sh
  echo "Нода зупинилась. Перезапуск через 90 секунд..."
  sleep 90
done
EOL
    chmod +x $HOME/run_forever.sh

    # stop script
    cat > $HOME/stop_aztec_node.sh << EOL
#!/bin/bash
screen -S aztec -X quit
echo "Нода зупинена."
EOL
    chmod +x $HOME/stop_aztec_node.sh

    echo ""
    echo "Крок 7/7: Встановлення завершено."

elif [[ "$choice" == "2" ]]; then
    echo "Запускаємо ноду в screen-сесії..."
    if screen -list | grep -q "\.aztec"; then
        echo "Нода вже запущена (екран знайдено)."
    else
        screen -dmS aztec bash -c "$HOME/run_forever.sh"
        echo "Нода запущена у фоновому режимі."
    fi

elif [[ "$choice" == "3" ]]; then
    echo "Зупиняємо ноду..."
    screen -S aztec -X quit && echo "Нода зупинена." || echo "Сесія не знайдена."
    docker ps -q --filter "ancestor=aztecprotocol/aztec" | xargs -r docker stop
    docker ps -aq --filter "ancestor=aztecprotocol/aztec" | xargs -r docker rm
else
    echo "Невірний вибір. Вихід."
    exit 1
fi
